#Activating required packages (have to be pre-installed using instal.packages('') function)
library(xts)
library(zoo)
library(dplyr)

#1transforming data to monthly frequency using last day of month
monthlydata <- aggregate(data, by = list(as.yearmon(data$date), permno = data$permno), FUN = tail, n=1)

#2merge the data with the ME breakpoint file

#Loading ME breakpoints
me_breakpoints <- read.csv('ME_Breakpoints.csv')
                      
#Converting characters into a date in two steps
me_breakpoints$X192512 <- as.character(me_breakpoints$X192512)
me_breakpoints$X192512 <- as.yearmon(me_breakpoints$X192512, format = "%Y%m")
                    
#Cutting relevants dates
relevant_dates <- me_breakpoints[769:1068, c(1,12)]
colnames(relevant_dates) <- c("Date", "breakpoints")
relevant_dates$breakpoints <- relevant_dates[,2] * 1000000

colnames(monthlydata)[1] = "Date"
colnames(relevant_dates)[1] = 'Date'

#Merging ME breakpoints and data2
mergeddata <- merge(monthlydata, relevant_dates, by = "Date")
                      
mergeddata["returns"] <- NA
mergeddata["cumreturns"] <- NA

mergeddata_tbl <- mergeddata %>%
  group_by(permno) %>%
  arrange(permno,Date) %>%
  mutate(return = ((price/lag(price,1))-1))

cleared_data = subset(mergeddata_tbl, select = -c(permno.1, returns, cumreturns))

#Finding cumulative returns
cleared_data_tbl <- cleared_data %>%
  group_by(permno) %>%
  arrange(permno,Date) %>%
  mutate(cumreturn = (price/lag(price,12))-1)

#Remove missing values
cleaned_data <- cleared_data_tbl[rowSums(is.na(cleared_data_tbl)) == 0,]

colnames(cleaned_data)[7] = "breakpoints"

top50portfolio <- subset(cleaned_data, cap>=breakpoints, select = c(1:9) )
bottom50portfolio <- subset(cleaned_data, cap<breakpoints, select = c(1:9) )

top50portfolio_tbl <- top50portfolio %>%
  group_by(Date) %>%
   arrange(Date, cumreturn, permno)

bottom50portfolio_tbl <- bottom50portfolio %>%
  group_by(Date) %>%
  arrange(Date, cumreturn, permno)




blablabla <- tally(group_by(top50portfolio_tbl, Date))
blablabla2 <- tally(group_by(bottom50portfolio_tbl, Date))




blablabla$nstocks <- blablabla$n/10
blablabla$mean <- mean(blablabla$nstocks)

blablabla2$nstocks <- blablabla2$n/10
blablabla2$mean <- mean(blablabla2$nstocks)

